# Modbus 模拟器与采集系统流程图

本文档基于 `pyModbus/sim_modbus.py` 的代码逻辑，使用 ASCII 流程图展示系统的运行流程、组件交互和数据流转。

## 1. 系统总体架构与初始化流程

系统主要由三个并发运行的组件构成：
1.  **Main (主控)**：负责编排、启动和停止其他组件。
2.  **ModbusSimulator (服务端)**：模拟 Modbus TCP 服务器，生成随机数据。
3.  **DeviceCollector (客户端)**：模拟数据采集设备，定期轮询读取数据。

```text
[程序启动]
    |
    +---> [读取 AppConfig 配置] (Host, Port, SlaveID, Interval)
    |
    +---> [初始化 ModbusSimulator]
    |       |
    |       +---> [启动模拟器后台任务] (asyncio.create_task)
    |
    +---> [初始化 DeviceCollector & ModbusClientWrapper]
            |
            +---> [启动采集器后台任务] (asyncio.create_task)
                    |
                    v
    [主线程进入等待状态] (await stop_event.wait())
            |
            | <--- 用户按下 Ctrl+C / 发送停止信号
            |
            v
    [开始优雅退出流程]
```

---

## 2. 模拟器 (Simulator) 内部逻辑

模拟器包含两个并行的子过程：
1.  **TCP Server**：监听端口，响应外部（包括采集器）的 Modbus 请求。
2.  **Data Generator**：后台不断更新寄存器数值，模拟真实世界的传感器波动。

```text
[ModbusSimulator]
    |
    +---> [初始化数据存储] (ModbusSequentialDataBlock)
    |       |
    |       +---> [设置初始值] (电压 220V, 电流 10A)
    |
    +---> {并发运行两个任务}
            |
            +---> [任务 1: TCP Server]
            |       |
            |       +---> [监听端口 5020]
            |               |
            |               +---> <收到读写请求>
            |                       |
            |                       +---> [处理 Modbus 请求] (读/写 寄存器)
            |
            +---> [任务 2: 数据生成器]
                    |
                    v
            <循环更新?>
              | Yes
              +---> [计算新值]
              |       |
              |       +---> [添加随机波动]
              |       |
              |       +---> [限制在合理范围] (210-230V)
              |
              +---> [更新寄存器值] (setValues)
              |
              +---> [休眠 0.5s]
              |       |
              |       +---> (回到循环开始)
              |
              | No / Cancel
              +---> [停止更新任务]
```

---

## 3. 采集器 (Collector) 与 客户端逻辑

采集器负责周期性地从服务器读取数据。它封装了连接管理（自动重连）和数据转换逻辑。

```text
[DeviceCollector]
    |
    +---> [启动采集任务]
            |
            v
    <运行中?>
      | Yes
      +---> [记录开始时间]
      |
      +---> [发起并发读取] (asyncio.gather)
      |       |
      |       +---> [ModbusClientWrapper]
      |               |
      |               v
      |       <连接正常?>
      |         | No
      |         +---> [尝试重连] (ensure_connected) ---+
      |         |                                      |
      |         | Yes                                  |
      |         +--------------------------------------+
      |         |
      |         +---> [发送 Modbus 请求] (read_holding_registers)
      |                 |
      |                 v
      |               [接收响应]
      |                 |
      |                 +---> Success: [返回寄存器数据]
      |                 |
      |                 +---> Error:   [返回 None]
      |                 |
      |                 +---> Exception: [标记断开连接]
      |
      +---> [解析数据] (Registers -> Float)
      |
      +---> [打印日志] (电压/电流/功率)
      |
      +---> [计算剩余等待时间]
      |
      +---> [休眠等待下一周期]
      |       |
      |       +---> (回到循环开始)
      |
      | No / Cancel
      +---> [停止采集]
```

---

## 4. 优雅退出流程 (Graceful Shutdown)

当用户按下 `Ctrl+C` 时，系统会按照特定顺序清理资源，防止端口占用或任务残留。

```text
[接收到停止信号]
    |
    v
[日志: 开始关闭资源]
    |
    +---> 1. [停止采集器]
    |       |
    |       +---> 设置 running=False
    |       +---> 取消采集任务 Task
    |       +---> 等待任务结束
    |
    +---> 2. [断开客户端连接]
    |       |
    |       +---> 关闭 TCP Socket
    |
    +---> 3. [停止模拟器]
    |       |
    |       +---> 停止数据生成任务
    |       +---> 取消 TCP Server 任务
    |       +---> 等待服务器关闭
    |
    v
[程序完全退出]
```

## 核心交互时序

```text
主程序 (Main)          模拟器 (Server)          采集器 (Client)
    |                       |                        |
    +--- 启动模拟器 (Task) --->|                        |
    |                       |-- 初始化寄存器            |
    |                       |-- 启动数据生成循环        |
    |                       |                        |
    +--- 启动采集器 (Task) --------------------------->|
                            |                        |
                            | <--- 数据采集周期 -----+ |
                            |                        | |
                            |<-- Modbus请求 (Read) --| |
                            |-- 响应 (Values) ------>| |
                            |                        | |
                            |           解析并打印日志 | |
                            |               休眠等待 | |
                            | <----------------------+ |
                            |                        |
    +--- (并发后台) ---------|                        |
    |                       |                        |
    |                       |<-- 每 0.5s 更新数据 ---+ |
    |                       |                        | |
    |                       |-- 更新寄存器 (波动) ----| |
    |                       | <----------------------+ |
    |                       |                        |
    | <--- 等待停止信号 ----|                        |
    |                       |                        |
  [用户按下 Ctrl+C]         |                        |
    |                       |                        |
    +----------------------------------------------> 停止采集任务
    |                       |                        |-- 断开连接
    |                       |                        |
    +---------------------> 停止模拟器任务             |
                            |                        |
  [退出]                    |                        |
```
